\usepackage{geometry}
\usepackage{tikz}
\usepackage{etoolbox}
\usepackage{tabto}
\usepackage{catchfile}
\usepackage{subfiles}
\usepackage[hidelinks]{hyperref}

% \usepackage{pdfTeX}
% \usepackage[demo]{graphicx}
\usetikzlibrary{positioning, fit, matrix, calc}
\usetikzlibrary{arrows.meta}
\usepackage{datatool}
\usepackage[l3]{csvsimple}
\usepackage{fontspec}
\usepackage{tikzpagenodes}
\usetikzlibrary{calc}
\usetikzlibrary{backgrounds}
\usepackage{anyfontsize}
\usepackage{atbegshi}
\usepackage[hashEnumerators,smartEllipses]{markdown}
\usepackage{contour}
\contourlength{0.8pt} % Adjust for outline thickness
% \usepackage{ifmtarg}% http://ctan.org/pkg/ifmtarg
\usepackage{substr}

\usepackage{xstring}
% \usepackage{xcolor}
\usepackage{graphicx}
% \usepackage[x11names]{xcolor}
% \usepackage[explicit]{titlesec}
\usepackage[newparttoc]{titlesec}
\usepackage{xcolor}
% \usepackage{titletoc}

\usepackage{multirow}
\usepackage{xparse}

\usepackage{wrapfig}

\usepackage{qrcode}
% for settings
    % \usepackage[utf8]{inputenc}
    % \usepackage{xcolor}

\usepackage{fourier, cabin}
\usepackage{linegoal, enumitem}
\usepackage{tabularx}
\usepackage{makecell}
\usepackage{scrextend}

\usepackage{textcomp}
\usepackage{afterpage}
\usepackage{placeins}
\usepackage{amssymb}


\usepackage{babel} % Load babel without language options initially


\providecommand{\tcversion}{v1.0.0}

% Set default language to English if LANG is not defined by the build command
\ifdefined\LANG\else
    \def\LANG{en}
\fi


% Load babel with the correct language option based on the LANG variable
% For Chinese, we use the xeCJK package which is designed for fontspec/xelatex.
% For other languages, we fall back to babel.
\IfStrEq{\LANG}{zh-hans}{
    \usepackage{xeCJK}
    \babelprovide[main,import]{chinese-simplified}
    \setCJKmainfont{NotoSansSC-VariableFont_wght.ttf}[Path=../fonts/]
    \setCJKsansfont{NotoSansSC-VariableFont_wght.ttf}[Path=../fonts/]
}{\IfStrEq{\LANG}{zh-hant}{
    \usepackage{xeCJK}
    \babelprovide[main,import]{chinese-traditional}
    \setCJKmainfont{NotoSansTC-VariableFont_wght.ttf}[Path=../fonts/]
    \setCJKsansfont{NotoSansTC-VariableFont_wght.ttf}[Path=../fonts/]
}{\IfStrEq{\LANG}{jp}{
    \usepackage{xeCJK}
    \babelprovide[main,import]{japanese}
    \setCJKmainfont{ZenOldMincho-Regular.ttf}[Path=../fonts/]
    \setCJKsansfont{ZenOldMincho-Regular.ttf}[Path=../fonts/]
}}{% For all other languages, select the language in babel and provide remapping
    % Use a case structure to map LANG code to babel language name
    \IfStrEqCase{\LANG}{
        {en}{\def\BabelLangName{english}}%
        {de}{\def\BabelLangName{german}}%
        {fr}{\def\BabelLangName{french}}%
        {es}{\def\BabelLangName{spanish}}%
        {it}{\def\BabelLangName{italian}}%
        {jp}{\def\BabelLangName{japanese}}%
        {pl}{\def\BabelLangName{polish}}%
        {pt}{\def\BabelLangName{portuguese}}%
        {ru}{\def\BabelLangName{russian}}%
        {nl}{\def\BabelLangName{dutch}}%
    }[\def\BabelLangName{\LANG}]% Default to LANG itself if no match
    \expandafter\babelprovide\expandafter[main,import]{\BabelLangName}
}
} 

\newcommand\underlinedlink[1]{\underline{\nameref{section:mod#1}}}

\geometry{a4paper, lmargin=6mm, rmargin=6mm, tmargin=2.5cm, bmargin=1.5cm}

\definecolor{sec}{HTML}{DD5C14}
\definecolor{band}{HTML}{EE9C52}

% \newfontfamily{\erasfont}{fonts/Eras-Bold-ITC.ttf}[]
\newfontfamily\amatica[
  Path = ../fonts/,
  Scale=1.0
  ] {RacingSansOne-Regular.ttf}
%   % ] {Eras-Bold-ITC.ttf}

% \newfontfamily\amatica[
%   Path = ../fonts/,
%   Scale=1.0
%   ] {HanyiSentyPagoda Regular.ttf}

% \newfontfamily{amatica}{HanyiSentyPagoda Regular.ttf}[Path=../fonts/, Scale=1.0]
\newfontfamily\arial[Scale=1.0]{Arial}
\input{fonts.tex}

% Define fonts only once to prevent "already defined" errors on subsequent LaTeX passes.
% Use \ifdefined to check if the font command exists before defining it.
% Use \providecommand to define the family command. This is more robust for multi-pass compilations.
  \IfStrEqCase{\LANG}{
    {zh-hans}{%
        \ifcsdef{titlefontcjk}{}{\newfontfamily\titlefontcjk{Fontquan-XinYiGuanHeiTi Regular.ttf}[Path=../fonts/]}
        \setCJKfamilyfont{titlefontCJK}{Fontquan-XinYiGuanHeiTi Regular.ttf}[Path=../fonts/]
        \providecommand{\titlefontfamily}{\titlefontcjk\CJKfamily{titlefontCJK}}
        % \setmainfont{Fontquan-XinYiGuanHeiTi Regular.ttf}[Path=../fonts/]
        \ifcsdef{racingsansone}{}{\newfontfamily\racingsansone{HanyiSentyPagoda Regular.ttf}[Path=../fonts/]}
        \setCJKfamilyfont{racingsansoneCJK}{HanyiSentyPagoda Regular.ttf}[Path=../fonts/]
        \providecommand{\racingsansonefamily}{\racingsansone\CJKfamily{racingsansoneCJK}}
        }%
    {zh-hant}{%
        \ifcsdef{titlefontcjk}{}{\newfontfamily\titlefontcjk{Fontquan-XinYiGuanHeiTi Regular.ttf}[Path=../fonts/]}
        \setCJKfamilyfont{titlefontCJK}{Fontquan-XinYiGuanHeiTi Regular.ttf}[Path=../fonts/]
        \providecommand{\titlefontfamily}{\titlefontcjk\CJKfamily{titlefontCJK}}
        \ifcsdef{racingsansone}{}{\newfontfamily\racingsansone{HanyiSentyPagoda Regular.ttf}[Path=../fonts/]}
        \setCJKfamilyfont{racingsansoneCJK}{HanyiSentyPagoda Regular.ttf}[Path=../fonts/]
        \providecommand{\racingsansonefamily}{\racingsansone\CJKfamily{racingsansoneCJK}}}%
}[% Fallback for non-CJK languages
    \ifcsdef{racingsansone}{}{\newfontfamily\racingsansone{RacingSansOne-Regular.ttf}[Path=../fonts/]}
    \providecommand{\racingsansonefamily}{\racingsansone}%
    \ifcsdef{titlefontlatin}{}{\newfontfamily\titlefontlatin{RacingSansOne-Regular.ttf}[Path=../fonts/]}
    \providecommand{\titlefontfamily}{\titlefontlatin}%
]

\usepackage{fancyhdr}

\fancypagestyle{plain}{
\fancyhf{} % clear all header and footer fields
\fancyfoot[R]{\titlefontfamily\fontsize{19pt}{19pt}\selectfont\thepage} % except the center
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}}
\pagestyle{plain}

\usepackage{xcolor}

\newcommand\boxedsection[1]{{
    \begin{tikzpicture}[inner sep=0pt, inner ysep=0.3ex] 

        \node[inner sep=2mm, outer sep = 1cm, color=white, anchor=base west] at (current page.west) (counter) {\thesection  \hskip0.75ex #1};
        \begin{pgfonlayer}{background}
            \draw[fill=black] (current bounding box.north -| current page.west) rectangle (current page.east |- current bounding box.south);
        \end{pgfonlayer}
    \end{tikzpicture}% 
}}

\newcommand\tocboxedpart[1]{{
  \begin{tikzpicture}[inner sep=0pt, inner ysep=0.3ex]
      \node[
        inner sep=2mm, 
        outer sep=3mm, 
        color=white, 
        anchor=base west,
        font=\titlefontfamily\fontsize{14}{14}\selectfont
      ] at (current page.west) (counter) {\thecontentslabel \hskip0.75ex #1};
        \begin{pgfonlayer}{background}
            \draw[fill=black] (current bounding box.north -| current page.west) rectangle (current page.east |- current bounding box.south);
        \end{pgfonlayer}
    \end{tikzpicture}%
}}


\newcommand\boxedsectionx[1]{{
  \begin{tikzpicture}[overlay,remember picture,line width=5pt, inner sep=0pt, inner ysep=0ex, outer sep=0pt]
  \fill[black] (current page.north west) rectangle ($(current page.north east)-(0,3cm)$);
  \fill [black] (current page.north west) rectangle ($(current page.north east)-(0,3cm)$);
  \node[
    rectangle,
    fill=none, 
    draw = none, 
    text = white, 
    minimum width=19cm, 
    minimum height=30mm, 
    font=\titlefontfamily\fontsize{17}{17}\selectfont,
    anchor = north
  ] at (current page.north) {#1};
  \end{tikzpicture}%
}}


  \newcommand\custompart[1]{{
  \begin{tikzpicture}[
    myrect/.style={
      rectangle,
      draw,
      inner sep=0pt,
      fit=#1},
    overlay,
    textbox/.style = {
      inner xsep = 2cm,
      inner ysep = 0.2cm,
    },
    remember picture,
    line width=5pt,
    inner sep=0pt,
    inner ysep=0ex
  ]
      \node [rectangle, fill=black, fit=(current page.south west) ($(current page.north east)!0.30!(current page.south east)$)] (partbox) {};

    \node[
      textbox,
    rectangle,
    fill=none, 
    draw = none, 
    text = white, 
    font=\titlefontfamily\fontsize{25}{25}\selectfont,
    anchor = north west,
  ] at (partbox.north west) {#1};


  \node[
    textbox,
    rectangle,
    fill=none, 
    draw = none, 
    text = black, 
    font=\titlefontfamily\fontsize{25}{25}\selectfont,
    anchor = south west,
  ] at (partbox.north west) {Part \thepart};
  \end{tikzpicture}%
}}

\titleformat{\section}
  {\Large}
  {}
  {0.5ex}
  {\boxedsectionx}

\titleformat{\part}[display]
  {\Large\bfseries}
  {}
  {0mm}
  {\custompart}


\usepackage{titletoc}

\setcounter{tocdepth}{3}
\contentsmargin{2.55em}

\titlecontents{part}[0pc]
{}%
{\tocboxedpart}% 
{}
{}
  
\titlecontents{section}[0pc]
{}%
{\begin{tikzpicture}[baseline={([yshift=-.8ex]current bounding box.center)},]
  \node [
    thick, draw=none, fill=none, rectangle, rounded corners
    ] {\thecontentslabel};
\end{tikzpicture}\quad}
{---}
{$:$ \titlerule[0.5pt]$:$ \large\thecontentspage}

\titlecontents{subsection}[1.8pc]
{}%
{\begin{tikzpicture}[baseline={([yshift=-.8ex]current bounding box.center)},]
\node [
  thick, draw=none, fill=none, rectangle, rounded corners
  ] {\thecontentslabel};
\end{tikzpicture}\quad}
{---}
{$:$ \titlerule[0.5pt]$:$ \large\thecontentspage}

\definecolor{m_orange}{RGB}{255,171,64}
\definecolor{m_green}{RGB}{69, 129, 142}
\definecolor{m_purple}{RGB}{142, 124, 195}
\definecolor{m_lightgray}{RGB}{235, 235, 235}
\definecolor{m_red}{RGB}{224, 102, 102}
\definecolor{mred}{RGB}{224, 102, 102}
\definecolor{mlightgray}{RGB}{235, 235, 235}
\definecolor{vo_green}{RGB}{207, 255, 12}


\makeatletter
\newcommand{\isempty}[1]{%
  \@ifmtarg{#1}{YES}{NO}}
\newcommand{\isnotempty}[1]{% 
  \@ifnotmtarg{#1}{YES}}
\makeatother

\graphicspath{{images/}}

\input{../shared/titlepage.tex}
